from flask import Flask, request, jsonify, render_template
from flask_cors import CORS  # <-- 1. IMPORT INI
import midtransclient
import uuid

app = Flask(__name__)
CORS(app)  # <-- 2. TAMBAHKAN INI (untuk mengizinkan koneksi dari React)

# ====== MIDTRANS CONFIG (SANDBOX) ======
# (Kunci Anda sudah benar di sini)
snap = midtransclient.Snap(
    is_production=False,
    server_key='Mid-server-nRnvystmVRjbzLWPfpUIc6Da',
    client_key='Mid-client-YrOZ1XhpKFqBSNee'
)

# 3. HAPUS ROUTE INI
#    Frontend Anda sekarang sudah di-handle oleh React,
#    jadi Flask tidak perlu lagi menyajikan 'index.html'.
#
# @app.route('/')
# def index():
#     return render_template('index.html')

@app.route('/create_transaction', methods=['POST'])
def create_transaction():
    # Logika Anda untuk membuat transaksi sudah benar.
    # Nanti, Anda bisa mengganti 'gross_amount: 50'
    # dengan data yang dikirim dari React.
    
    order_id = f"order-{uuid.uuid4().hex[:10]}"

    params = {
        "transaction_details": {
            "order_id": order_id,
            "gross_amount": 50  # Nanti ini bisa diambil dari request JSON
        },
        "credit_card": {"secure": True},
        "customer_details": {
            "first_name": "John",
            "last_name": "Doe",
            "email": "customer@example.com",
            "phone": "+628123456789"
        }
    }

    try:
        transaction = snap.create_transaction(params)
        # Frontend React akan menerima: { "token": "...", "redirect_url": "..." }
        return jsonify(transaction)
    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    # 4. TENTUKAN PORT 5000 SECARA EKSPLISIT
    #    Ini agar konsisten dengan panggilan 'fetch()' di React
    app.run(debug=True, port=5000)